import pickle
from datetime import datetime, date
import os


# ============================================================
#   VARIÁVEIS E CONSTANTES DO SISTEMA
# ============================================================

reservas = []  # lista principal de reservas
arquivo_dados = "reservas.pkl"

CAPACIDADE_QUARTOS = {
    "standard": 10,
    "premium": 5,
    "luxo": 3
}

VALORES_QUARTOS = {
    "standard": 100,
    "premium": 180,
    "luxo": 250
}


# ============================================================
#   FUNÇÕES AUXILIARES
# ============================================================

def limpar_tela():
    os.system("cls" if os.name == "nt" else "clear")


def ler_data(msg):
    """Lê uma data no formato dd/mm/aaaa e retorna datetime.date"""
    while True:
        try:
            return datetime.strptime(input(msg).strip(), "%d/%m/%Y").date()
        except:
            print("Data inválida! Use o formato dd/mm/aaaa.")


def datas_sobrepoem(ci1, co1, ci2, co2):
    """Verifica se dois intervalos de datas se sobrepõem"""
    return ci1 < co2 and ci2 < co1


def exibir_reserva(r):
    noites = (r["checkout"] - r["checkin"]).days
    print(f"""
Responsável: {r['responsavel']}
Check-in: {r['checkin'].strftime("%d/%m/%Y")}
Check-out: {r['checkout'].strftime("%d/%m/%Y")}
Noites: {noites}
Tipo: {r['tipo_quarto']}
Quantidade de quartos: {r['quantidade_quartos']}
Valor total: R$ {r['valor_total']:.2f}
--------------------------------------------
""")


# ============================================================
#   SALVAR E CARREGAR DADOS
# ============================================================

def carregar_dados():
    global reservas
    if os.path.exists(arquivo_dados):
        try:
            with open(arquivo_dados, "rb") as f:
                reservas = pickle.load(f)
                if not isinstance(reservas, list):
                    reservas = []
        except:
            reservas = []
    else:
        reservas = []


def salvar_dados():
    with open(arquivo_dados, "wb") as f:
        pickle.dump(reservas, f)


# ============================================================
#   VERIFICAÇÃO DE DISPONIBILIDADE
# ============================================================

def verificar_disponibilidade(checkin, checkout, tipo_quarto, quantidade):
    ocupados = 0

    for r in reservas:
        if r["tipo_quarto"] == tipo_quarto:
            if datas_sobrepoem(checkin, checkout, r["checkin"], r["checkout"]):
                ocupados += r["quantidade_quartos"]

    disponiveis = CAPACIDADE_QUARTOS[tipo_quarto] - ocupados
    return disponiveis >= quantidade, disponiveis


# ============================================================
#   CADASTRO DE RESERVA
# ============================================================

def cadastrar_reserva():
    print("\n=== CADASTRAR RESERVA ===")

    responsavel = input("Digite o nome do responsável: ").strip().lower()

    checkin = ler_data("Data de check-in (dd/mm/aaaa): ")
    checkout = ler_data("Data de check-out (dd/mm/aaaa): ")

    if checkout <= checkin:
        print("A data de check-out deve ser posterior à data de check-in.")
        return

    print("\nTipos disponíveis: Standard, Premium, Luxo")
    tipo = input("Tipo de quarto: ").strip().lower()

    if tipo not in CAPACIDADE_QUARTOS:
        print("Tipo de quarto inválido.")
        return

    try:
        quantidade = int(input("Quantidade de quartos: "))
    except:
        print("Quantidade inválida.")
        return

    disponivel, livres = verificar_disponibilidade(checkin, checkout, tipo, quantidade)

    if not disponivel:
        print(f"\n⚠ Não há disponibilidade suficiente.\nQuartos livres: {livres}")
        return

    noites = (checkout - checkin).days
    valor_total = noites * quantidade * VALORES_QUARTOS[tipo]

    nova_reserva = {
        "responsavel": responsavel,
        "checkin": checkin,
        "checkout": checkout,
        "tipo_quarto": tipo,
        "quantidade_quartos": quantidade,
        "valor_total": valor_total
    }

    reservas.append(nova_reserva)
    salvar_dados()
    print("\nReserva cadastrada com sucesso!")


# ============================================================
#   CONSULTAR RESERVAS
# ============================================================

def consultar_reservas():
    print("\n=== CONSULTAR RESERVAS POR NOME ===")
    nome = input("Digite o nome: ").lower()

    encontradas = [r for r in reservas if nome in r["responsavel"]]

    if not encontradas:
        print("Nenhuma reserva encontrada.")
        return

    for r in encontradas:
        exibir_reserva(r)


# ============================================================
#   CONSULTAR DISPONIBILIDADE
# ============================================================

def consultar_disponibilidade():
    print("\n=== CONSULTAR DISPONIBILIDADE ===")

    checkin = ler_data("Data de check-in: ")
    checkout = ler_data("Data de check-out: ")

    tipo = input("Tipo de quarto: ").lower()
    if tipo not in CAPACIDADE_QUARTOS:
        print("Tipo inválido.")
        return

    try:
        quantidade = int(input("Quantidade de quartos: "))
    except:
        print("Inválido.")
        return

    ok, livres = verificar_disponibilidade(checkin, checkout, tipo, quantidade)

    if ok:
        print("Há disponibilidade suficiente.")
    else:
        print(f"Não há disponibilidade. Máximo possível: {livres}")


# ============================================================
#   CANCELAR RESERVA
# ============================================================

def cancelar_reservas():
    print("\n=== CANCELAR RESERVA ===")

    nome = input("Digite o nome do responsável: ").lower()

    futuras = [r for r in reservas if nome in r["responsavel"] and r["checkin"] > date.today()]

    if not futuras:
        print("Nenhuma reserva futura encontrada.")
        return

    print("\nReservas futuras:")
    for i, r in enumerate(futuras, 1):
        print(f"\nReserva {i}:")
        exibir_reserva(r)

    try:
        escolha = int(input("Escolha a reserva para cancelar: "))
        alvo = futuras[escolha - 1]
    except:
        print("Opção inválida.")
        return

    reservas.remove(alvo)
    salvar_dados()
    print("\nReserva cancelada com sucesso!")


# ============================================================
#   LISTAR TODAS AS RESERVAS
# ============================================================

def listar_reservas():
    print("\n=== TODAS AS RESERVAS ===")

    if not reservas:
        print("Nenhuma reserva cadastrada.")
        return

    ordenadas = sorted(reservas, key=lambda r: (r["checkin"], r["responsavel"]))

    for r in ordenadas:
        exibir_reserva(r)


# ============================================================
#   ESTATÍSTICAS
# ============================================================

def exibir_estatisticas():
    print("\n=== ESTATÍSTICAS ===")

    if not reservas:
        print("Nenhuma reserva cadastrada.")
        return

    total = len(reservas)
    soma = sum(r["valor_total"] for r in reservas)
    mais_cara = max(reservas, key=lambda r: r["valor_total"])
    mais_longa = max(reservas, key=lambda r: (r["checkout"] - r["checkin"]).days)

    qtd_por_tipo = {"standard": 0, "premium": 0, "luxo": 0}
    for r in reservas:
        qtd_por_tipo[r["tipo_quarto"]] += r["quantidade_quartos"]

    print(f"""
Total de reservas: {total}
Soma total: R$ {soma:.2f}

Reserva mais cara:
  - Responsável: {mais_cara['responsavel']}
  - Valor: R$ {mais_cara['valor_total']:.2f}

Reserva mais longa:
  - Responsável: {mais_longa['responsavel']}
  - Noites: {(mais_longa['checkout'] - mais_longa['checkin']).days}

Quartos reservados por categoria:
  Standard: {qtd_por_tipo["standard"]}
  Premium:  {qtd_por_tipo["premium"]}
  Luxo:     {qtd_por_tipo["luxo"]}
""")


# ============================================================
#   MENU PRINCIPAL
# ============================================================

def main():
    carregar_dados()

    while True:
        print("""
==============================
        MENU PRINCIPAL
==============================

[1] Cadastrar reserva
[2] Carregar reservas
[3] Consultar disponibilidade
[4] Cancelar reserva
[5] Listar reservas
[6] Exibir estatísticas
[7] Sair
""")

        opcao = input("Escolha uma opção: ")

        if opcao == "1":
            cadastrar_reserva()
        elif opcao == "2":
            carregar_dados()
            print("Reservas carregadas.")
        elif opcao == "3":
            consultar_disponibilidade()
        elif opcao == "4":
            cancelar_reservas()
        elif opcao == "5":
            listar_reservas()
        elif opcao == "6":
            exibir_estatisticas()
        elif opcao == "7":
            salvar_dados()
            print("Encerrando...")
            break
        else:
            print("Opção inválida!")


main()
